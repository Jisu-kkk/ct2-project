<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.ct2.repo.ProjectMapper">

    <select id="selectProjectList" resultType="map" parameterType="map">
        SELECT pj.id
             , pj.name
             , pj.client_name
             , DATE_FORMAT(pj.finish_date, '%Y.%m') AS finish_date
             , f.id AS file_id
             , CONCAT(f.original_name, f.type) AS oriFileName
             , CONCAT(f.name, f.type) AS fileName
          FROM project pj
     LEFT JOIN file f
            ON f.id = pj.file_id
         WHERE pj.organization_code = #{orgCode}
           AND pj.is_use = 1
           AND pj.is_delete = 0
    </select>

    <select id="selectProjectTag" resultType="map" parameterType="map">
        SELECT t.tag_name AS tagName
          FROM project_tag pt
     LEFT JOIN tag t
            ON t.tag_id = pt.tag_id
         WHERE pt.project_id = #{id}
    </select>

    <select id="adminProjectList" resultType="map" parameterType="map">
        SELECT @ROWNUM := @ROWNUM + 1 num
             , A.*
          FROM (
                SELECT pj.id
                     , pj.name AS pj_name
                     , pj.client_name
                     , pj.is_use
                     , u.name AS u_name
                     , pj.create_datetime
                     , DATE_FORMAT(pj.create_datetime, '%Y-%m-%d') AS create_dt
                  FROM project pj
             LEFT JOIN (
                        SELECT *
                          FROM user
                         WHERE LEFT(organization_code, 8) = 'BS003002'
                       ) u
                    ON u.id = pj.create_user
                 JOIN (
                        SELECT pt.project_id
                             , t.tag_id
                             , t.tag_name
                             , t.tag_type
                          FROM project_tag pt
                          JOIN tag t
                            ON t.tag_id = pt.tag_id
                         WHERE t.tag_id = 5
                       ) t
                    ON t.project_id = pj.id
                 WHERE pj.is_delete = 0
              ORDER BY create_datetime DESC
               ) A
         WHERE (@ROWNUM := 0) = 0
    </select>
</mapper>
